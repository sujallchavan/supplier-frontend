<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Supplier Dashboard</title>
    <!-- Font Awesome for icons -->
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"
    />
    <style>
      :root {
        --primary-color: #4e73df;
        --secondary-color: #f8f9fc;
        --accent-color: #2e59d9;
        --text-color: #5a5c69;
        --light-gray: #dddfeb;
        --success-color: #1cc88a;
        --danger-color: #e74a3b;
        --warning-color: #f6c23e;
      }

      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      body {
        font-family: "Nunito", -apple-system, BlinkMacSystemFont, "Segoe UI",
          Roboto, "Helvetica Neue", Arial, sans-serif;
        background-color: #f8f9fc;
        color: var(--text-color);
        min-height: 100vh;
        display: flex;
      }

      /* Sidebar Styles */
      .sidebar {
        width: 250px;
        background: linear-gradient(
          180deg,
          var(--primary-color) 10%,
          rgba(78, 115, 223, 0.9) 100%
        );
        background-color: var(--primary-color);
        color: white;
        min-height: 100vh;
        transition: all 0.3s;
        position: fixed;
        z-index: 1000;
      }

      .sidebar-header {
        padding: 1.5rem 1.5rem 0.5rem;
        font-weight: 800;
        font-size: 1.2rem;
        text-align: center;
        border-bottom: 1px solid rgba(255, 255, 255, 0.2);
      }

      .sidebar-menu {
        padding: 0 1rem;
      }

      .nav-item {
        margin: 0.5rem 0;
      }

      .nav-link {
        color: rgba(255, 255, 255, 0.8);
        padding: 0.75rem 1rem;
        display: flex;
        align-items: center;
        border-radius: 0.35rem;
        text-decoration: none;
        transition: all 0.3s;
      }

      .nav-link:hover,
      .nav-link.active {
        color: white;
        background-color: rgba(255, 255, 255, 0.1);
      }

      .nav-link i {
        margin-right: 0.5rem;
        font-size: 0.85rem;
      }

      /* Main Content Styles */
      .main-content {
        flex: 1;
        margin-left: 250px;
        transition: all 0.3s;
      }

      .topbar {
        height: 4.375rem;
        box-shadow: 0 0.15rem 1.75rem 0 rgba(58, 59, 69, 0.15);
        background-color: white;
        padding: 0 1.5rem;
        display: flex;
        align-items: center;
        justify-content: space-between;
      }

      .topbar h1 {
        font-size: 1.5rem;
        font-weight: 700;
        color: var(--text-color);
        margin: 0;
      }

      .user-info {
        display: flex;
        align-items: center;
        cursor: pointer;
        position: relative;
      }

      .user-info img {
        width: 40px;
        height: 40px;
        border-radius: 50%;
        margin-right: 10px;
        object-fit: cover;
      }

      .user-info .user-icon {
        font-size: 1.5rem;
        color: var(--primary-color);
      }

      .container-fluid {
        padding: 1.5rem;
      }

      /* Card Styles */
      .card {
        border: none;
        border-radius: 0.35rem;
        box-shadow: 0 0.15rem 1.75rem 0 rgba(58, 59, 69, 0.1);
        margin-bottom: 1.5rem;
        background-color: white;
      }

      .card-header {
        background-color: #f8f9fc;
        border-bottom: 1px solid #e3e6f0;
        padding: 1rem 1.35rem;
        font-weight: 700;
        color: var(--text-color);
        border-radius: 0.35rem 0.35rem 0 0 !important;
      }

      .card-body {
        padding: 1.5rem;
      }

      /* Table Styles */
      .table {
        width: 100%;
        margin-bottom: 1rem;
        color: var(--text-color);
        border-collapse: collapse;
      }

      .table th {
        background-color: #f8f9fc;
        padding: 0.75rem;
        vertical-align: top;
        border-top: 1px solid #e3e6f0;
        text-align: left;
        font-weight: 700;
      }

      .table td {
        padding: 0.75rem;
        vertical-align: top;
        border-top: 1px solid #e3e6f0;
      }

      .table-responsive {
        display: block;
        width: 100%;
        overflow-x: auto;
        -webkit-overflow-scrolling: touch;
      }

      /* Button Styles */
      .btn {
        display: inline-block;
        font-weight: 400;
        text-align: center;
        white-space: nowrap;
        vertical-align: middle;
        user-select: none;
        border: 1px solid transparent;
        padding: 0.375rem 0.75rem;
        font-size: 0.875rem;
        line-height: 1.5;
        border-radius: 0.35rem;
        transition: all 0.15s ease-in-out;
        cursor: pointer;
      }

      .btn-success {
        color: white;
        background-color: var(--success-color);
        border-color: var(--success-color);
      }

      .btn-success:hover {
        background-color: #17a673;
        border-color: #169b6b;
      }

      .btn-danger {
        color: white;
        background-color: var(--danger-color);
        border-color: var(--danger-color);
      }

      .btn-danger:hover {
        background-color: #d62c1a;
        border-color: #c52717;
      }

      .btn-logout {
        color: white;
        background-color: var(--danger-color);
        border-color: var(--danger-color);
        padding: 0.5rem 1rem;
      }

      /* Supplier Info Styles */
      .supplier-info {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
        gap: 1.5rem;
        margin-bottom: 1.5rem;
      }

      .info-item {
        background-color: white;
        border-radius: 0.35rem;
        padding: 1.5rem;
        box-shadow: 0 0.15rem 1.75rem 0 rgba(58, 59, 69, 0.1);
      }

      .info-item h3 {
        font-size: 1rem;
        color: var(--text-color);
        margin-bottom: 0.5rem;
        font-weight: 700;
      }

      .info-item p {
        font-size: 1.25rem;
        font-weight: 600;
        color: var(--primary-color);
        margin: 0;
      }

      /* Modal Styles */
      .modal {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0, 0, 0, 0.5);
        z-index: 2000;
        justify-content: center;
        align-items: center;
      }

      .modal-content {
        background-color: white;
        border-radius: 0.5rem;
        width: 90%;
        max-width: 500px;
        box-shadow: 0 0.5rem 1rem rgba(0, 0, 0, 0.15);
        overflow: hidden;
        animation: modalFadeIn 0.3s;
      }

      @keyframes modalFadeIn {
        from {
          opacity: 0;
          transform: translateY(-20px);
        }
        to {
          opacity: 1;
          transform: translateY(0);
        }
      }

      .modal-header {
        background-color: var(--primary-color);
        color: white;
        padding: 1rem 1.5rem;
        display: flex;
        justify-content: space-between;
        align-items: center;
      }

      .modal-header h3 {
        margin: 0;
        font-size: 1.25rem;
      }

      .modal-close {
        background: none;
        border: none;
        color: white;
        font-size: 1.5rem;
        cursor: pointer;
      }

      .modal-body {
        padding: 1.5rem;
      }

      .modal-footer {
        padding: 1rem 1.5rem;
        background-color: #f8f9fc;
        border-top: 1px solid #e3e6f0;
        display: flex;
        justify-content: flex-end;
      }

      .modal-profile {
        display: flex;
        align-items: center;
        margin-bottom: 1.5rem;
      }

      .modal-profile-img {
        width: 80px;
        height: 80px;
        border-radius: 50%;
        object-fit: cover;
        margin-right: 1.5rem;
        background-color: #f0f0f0;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 2.5rem;
        color: var(--primary-color);
      }

      .modal-profile-info h4 {
        margin: 0 0 0.5rem 0;
        font-size: 1.5rem;
      }

      .modal-profile-info p {
        margin: 0;
        color: var(--text-color);
      }

      .modal-details {
        margin-top: 1.5rem;
      }

      .modal-detail-item {
        margin-bottom: 1rem;
        padding-bottom: 1rem;
        border-bottom: 1px solid #eee;
      }

      .modal-detail-item:last-child {
        margin-bottom: 0;
        padding-bottom: 0;
        border-bottom: none;
      }

      .modal-detail-item h5 {
        margin: 0 0 0.25rem 0;
        font-size: 0.875rem;
        color: #6c757d;
      }

      .modal-detail-item p {
        margin: 0;
        font-size: 1rem;
      }

      /* Responsive Styles */
      @media (max-width: 992px) {
        .sidebar {
          margin-left: -250px;
        }

        .main-content {
          margin-left: 0;
        }

        .sidebar.active {
          margin-left: 0;
        }

        .main-content.active {
          margin-left: 250px;
        }
      }

      @media (max-width: 768px) {
        .supplier-info {
          grid-template-columns: 1fr;
        }

        .modal-content {
          width: 95%;
        }

        .modal-profile {
          flex-direction: column;
          text-align: center;
        }

        .modal-profile-img {
          margin-right: 0;
          margin-bottom: 1rem;
        }
      }

      /* Toggle Button for Mobile */
      .sidebar-toggle {
        display: none;
        background: none;
        border: none;
        font-size: 1.5rem;
        color: var(--text-color);
        cursor: pointer;
      }

      @media (max-width: 992px) {
        .sidebar-toggle {
          display: block;
        }
      }

      /* No Data Message */
      .no-data {
        text-align: center;
        padding: 2rem;
        color: var(--text-color);
        font-style: italic;
      }
    </style>
  </head>
  <body>
    <!-- Sidebar -->
    <div class="sidebar" id="sidebar">
      <div class="sidebar-header">
        <span>Supplier Portal</span>
      </div>
      <div class="sidebar-menu">
        <div class="nav-item">
          <a href="#" class="nav-link active">
            <i class="fas fa-fw fa-tachometer-alt"></i>
            <span>Dashboard</span>
          </a>
        </div>
        <div class="nav-item">
          <a href="#" class="nav-link">
            <i class="fas fa-fw fa-clipboard-list"></i>
            <span>Orders</span>
          </a>
        </div>
        <div class="nav-item">
          <a href="#" class="nav-link">
            <i class="fas fa-fw fa-check-circle"></i>
            <span>Accepted Orders</span>
          </a>
        </div>
        <div class="nav-item">
          <a href="#" class="nav-link">
            <i class="fas fa-fw fa-times-circle"></i>
            <span>Rejected Orders</span>
          </a>
        </div>
        <div class="nav-item">
          <a href="#" class="nav-link">
            <i class="fas fa-fw fa-cog"></i>
            <span>Settings</span>
          </a>
        </div>
        <div class="nav-item">
          <button
            id="logout"
            class="nav-link btn-logout"
            style="width: 100%; text-align: left"
          >
            <i class="fas fa-fw fa-sign-out-alt"></i>
            <span>Logout</span>
          </button>
        </div>
      </div>
    </div>

    <!-- Main Content -->
    <div class="main-content" id="main-content">
      <!-- Topbar -->
      <nav class="topbar">
        <button class="sidebar-toggle" id="sidebarToggle">
          <i class="fas fa-bars"></i>
        </button>
        <h1>Supplier Dashboard</h1>
        <div class="user-info" id="userInfoTop">
          <span>Loading...</span>
        </div>
      </nav>

      <!-- Page Content -->
      <div class="container-fluid">
        <!-- Supplier Information -->
        <div class="card mb-4">
          <div class="card-header">
            <h2>Supplier Information</h2>
          </div>
          <div class="card-body">
            <div class="supplier-info" id="supplierInfo">
              <!-- Dynamically filled by JavaScript -->
            </div>
          </div>
        </div>

        <!-- Customer Orders -->
        <div class="card mb-4">
          <div class="card-header">
            <h2>Customer Orders</h2>
          </div>
          <div class="card-body">
            <div class="table-responsive">
              <div id="orders">
                <p>Fetching orders...</p>
              </div>
            </div>
          </div>
        </div>

        <!-- Accepted Orders -->
        <div class="card mb-4">
          <div class="card-header">
            <h2>Accepted Orders</h2>
          </div>
          <div class="card-body">
            <div class="table-responsive">
              <div id="acceptedOrders">
                <p>Fetching accepted orders...</p>
              </div>
            </div>
          </div>
        </div>

        <!-- Rejected Orders -->
        <div class="card mb-4">
          <div class="card-header">
            <h2>Rejected Orders</h2>
          </div>
          <div class="card-body">
            <div class="table-responsive">
              <div id="rejectedOrders">
                <p>Fetching rejected orders...</p>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- User Profile Modal -->
    <div class="modal" id="userModal">
      <div class="modal-content">
        <div class="modal-header">
          <h3>Supplier Profile</h3>
          <button class="modal-close" id="modalClose">&times;</button>
        </div>
        <div class="modal-body" id="modalBody">
          <!-- Dynamically filled by JavaScript -->
        </div>
        <div class="modal-footer">
          <button class="btn btn-logout" id="modalLogout">
            <i class="fas fa-sign-out-alt"></i> Logout
          </button>
        </div>
      </div>
    </div>

    <script>
      // Toggle sidebar on mobile
      document
        .getElementById("sidebarToggle")
        .addEventListener("click", function () {
          document.getElementById("sidebar").classList.toggle("active");
          document.getElementById("main-content").classList.toggle("active");
        });

      // Modal functionality
      const userModal = document.getElementById("userModal");
      const modalClose = document.getElementById("modalClose");
      const modalLogout = document.getElementById("modalLogout");

      // Open modal when clicking user info
      document
        .getElementById("userInfoTop")
        .addEventListener("click", function () {
          userModal.style.display = "flex";
          document.body.style.overflow = "hidden"; // Prevent scrolling when modal is open
        });

      // Close modal when clicking close button
      modalClose.addEventListener("click", function () {
        userModal.style.display = "none";
        document.body.style.overflow = "auto";
      });

      // Close modal when clicking outside
      userModal.addEventListener("click", function (e) {
        if (e.target === userModal) {
          userModal.style.display = "none";
          document.body.style.overflow = "auto";
        }
      });

      // Logout from modal
      modalLogout.addEventListener("click", function () {
        sessionStorage.clear();
        window.location.href = "login.html";
      });

      const supplierData = sessionStorage.getItem("supplier");

      if (supplierData) {
        const supplier = JSON.parse(supplierData);

        // Update top user info
        document.getElementById("userInfoTop").innerHTML = `
          <i class="fas fa-user-circle user-icon"></i>
          <span>${supplier.name}</span>
        `;

        // Update modal content
        document.getElementById("modalBody").innerHTML = `
          <div class="modal-profile">
            <div class="modal-profile-img">
              <i class="fas fa-user-tie"></i>
            </div>
            <div class="modal-profile-info">
              <h4>${supplier.name}</h4>
              <p>${supplier.companyName || "No Company"}</p>
              <p>${supplier.category || "No Category"}</p>
            </div>
          </div>
          <div class="modal-details">
            <div class="modal-detail-item">
              <h5>Supplier ID</h5>
              <p>${supplier.supplierId}</p>
            </div>
            <div class="modal-detail-item">
              <h5>Email</h5>
              <p>${supplier.email}</p>
            </div>
            <div class="modal-detail-item">
              <h5>Phone</h5>
              <p>${supplier.phoneNumber || "N/A"}</p>
            </div>
            <div class="modal-detail-item">
              <h5>Location</h5>
              <p>${supplier.location || "N/A"}</p>
            </div>
          </div>
        `;

        // Update supplier info cards
        document.getElementById("supplierInfo").innerHTML = `
          <div class="info-item">
            <h3>Supplier ID</h3>
            <p>${supplier.supplierId}</p>
          </div>
          <div class="info-item">
            <h3>Name</h3>
            <p>${supplier.name}</p>
          </div>
          <div class="info-item">
            <h3>Email</h3>
            <p>${supplier.email}</p>
          </div>
          <div class="info-item">
            <h3>Phone</h3>
            <p>${supplier.phoneNumber || "N/A"}</p>
          </div>
          <div class="info-item">
            <h3>Company</h3>
            <p>${supplier.companyName || "N/A"}</p>
          </div>
          <div class="info-item">
            <h3>Category</h3>
            <p>${supplier.category || "N/A"}</p>
          </div>
          <div class="info-item">
            <h3>Address</h3>
            <p>${supplier.location || "N/A"}</p>
          </div>
        `;

        fetchOrders(supplier);
      } else {
        document.getElementById("supplierInfo").innerHTML = `
          <div class="info-item" style="grid-column: 1 / -1;">
            <h3>Error</h3>
            <p>Not logged in!</p>
          </div>
        `;
        window.location.href = "login.html";
      }

      function fetchOrders(supplier) {
        fetch(
          `http://localhost:5000/api/suppliers/orders?category=${supplier.category}`
        )
          .then((response) => response.json())
          .then((orders) => {
            const ordersContainer = document.getElementById("orders");
            ordersContainer.innerHTML = "";

            // Filter only orders that are approved
            let approvedOrders = orders.filter(
              (order) => order.isApproved === "Approved"
            );

            // Exclude orders that are already accepted or rejected
            let pendingOrders = approvedOrders.filter(
              (order) =>
                !order.supplierResponses ||
                !order.supplierResponses.some(
                  (response) =>
                    response.supplier_Id === supplier.supplierId &&
                    (response.status === "Accepted" ||
                      response.status === "Rejected")
                )
            );

            if (pendingOrders.length === 0) {
              ordersContainer.innerHTML =
                '<div class="no-data">No pending orders available.</div>';
              fetchAcceptedOrders(supplier, approvedOrders);
              fetchRejectedOrders(supplier, approvedOrders);
              return;
            }

            const table = document.createElement("table");
            table.className = "table";
            table.innerHTML = `
                <thead>
                  <tr>
                      <th>Order ID</th>
                      <th>Customer</th>
                      <th>Part</th>
                      <th>Category</th>
                      <th>Status</th>
                      <th>Description</th>
                      <th>Quantity</th>
                      <th>Price</th>
                      <th>Approval Status</th>
                      <th>Action</th>
                  </tr>
                </thead>
                <tbody id="ordersTableBody">
                </tbody>
            `;

            const tbody = document.createElement("tbody");
            pendingOrders.forEach((order) => {
              const row = document.createElement("tr");
              row.innerHTML = `
                    <td>${order.order_id}</td>
                    <td>${order.cname} (${order.email})</td>
                    <td>${order.Part_Name}</td>
                    <td>${order.category}</td>
                    <td>${order.working_status}</td>
                    <td>${order.desc}</td>
                    <td>${order.tv}</td>
                    <td>${order.pr}</td>
                    <td>${order.isApproved}</td>
                    <td>
                        <button class="btn btn-success" onclick="updateOrderStatus('${order.order_id}', '${supplier.supplierId}', 'Accepted')">Accept</button>
                        <button class="btn btn-danger" onclick="updateOrderStatus('${order.order_id}', '${supplier.supplierId}', 'Rejected')">Reject</button>
                    </td>
                `;
              tbody.appendChild(row);
            });

            table.appendChild(tbody);
            ordersContainer.appendChild(table);
            fetchAcceptedOrders(supplier, approvedOrders);
            fetchRejectedOrders(supplier, approvedOrders);
          })
          .catch((error) => {
            console.error("Error fetching orders:", error);
            document.getElementById("orders").innerHTML =
              '<div class="no-data">Failed to fetch orders. Please try again later.</div>';
          });
      }

      function fetchAcceptedOrders(supplier, orders) {
        const acceptedOrders = orders.filter(
          (order) =>
            order.supplierResponses &&
            order.supplierResponses.some(
              (response) =>
                response.supplier_Id === supplier.supplierId &&
                response.status === "Accepted"
            )
        );

        const acceptedOrdersContainer =
          document.getElementById("acceptedOrders");
        acceptedOrdersContainer.innerHTML = "";

        if (acceptedOrders.length === 0) {
          acceptedOrdersContainer.innerHTML =
            '<div class="no-data">No accepted orders found.</div>';
          return;
        }

        const table = document.createElement("table");
        table.className = "table";
        table.innerHTML = `
          <thead>
            <tr>
              <th>Order ID</th>
              <th>Customer</th>
              <th>Part</th>
              <th>Category</th>
              <th>Status</th>
              <th>Description</th>
              <th>Quantity</th>
              <th>Price</th>
              <th>Supplier ID</th>
              <th>Supplier Responses</th>
            </tr>
          </thead>
          <tbody id="acceptedOrdersTableBody">
          </tbody>
        `;

        const tbody = document.createElement("tbody");
        acceptedOrders.forEach((order) => {
          const supplierResponse = order.supplierResponses.find(
            (response) => response.supplier_Id === supplier.supplierId
          );

          const row = document.createElement("tr");
          row.innerHTML = `
            <td>${order.order_id}</td>
            <td>${order.cname} (${order.email})</td>
            <td>${order.Part_Name}</td>
            <td>${order.category}</td>
            <td>${order.working_status}</td>
            <td>${order.desc}</td>
            <td>${order.tv}</td>
            <td>${order.pr}</td>
            <td>${supplierResponse.supplier_Id}</td>
            <td>${supplierResponse.status}</td>
          `;
          tbody.appendChild(row);
        });

        table.appendChild(tbody);
        acceptedOrdersContainer.appendChild(table);
      }

      function fetchRejectedOrders(supplier, orders) {
        const rejectedOrders = orders.filter(
          (order) =>
            order.supplierResponses &&
            order.supplierResponses.some(
              (response) =>
                response.supplier_Id === supplier.supplierId &&
                response.status === "Rejected"
            )
        );

        const rejectedOrdersContainer =
          document.getElementById("rejectedOrders");
        rejectedOrdersContainer.innerHTML = "";

        if (rejectedOrders.length === 0) {
          rejectedOrdersContainer.innerHTML =
            '<div class="no-data">No rejected orders found.</div>';
          return;
        }

        const table = document.createElement("table");
        table.className = "table";
        table.innerHTML = `
          <thead>
            <tr>
              <th>Order ID</th>
              <th>Customer</th>
              <th>Part</th>
              <th>Category</th>
              <th>Status</th>
              <th>Description</th>
              <th>Quantity</th>
              <th>Price</th>
              <th>Supplier ID</th>
              <th>Supplier Responses</th>
            </tr>
          </thead>
          <tbody id="rejectedOrdersTableBody">
          </tbody>
        `;

        const tbody = document.createElement("tbody");
        rejectedOrders.forEach((order) => {
          const supplierResponse = order.supplierResponses.find(
            (response) => response.supplier_Id === supplier.supplierId
          );

          const row = document.createElement("tr");
          row.innerHTML = `
            <td>${order.order_id}</td>
            <td>${order.cname} (${order.email})</td>
            <td>${order.Part_Name}</td>
            <td>${order.category}</td>
            <td>${order.working_status}</td>
            <td>${order.desc}</td>
            <td>${order.tv}</td>
            <td>${order.pr}</td>
            <td>${supplierResponse.supplier_Id}</td>
            <td>${supplierResponse.status}</td>
          `;
          tbody.appendChild(row);
        });

        table.appendChild(tbody);
        rejectedOrdersContainer.appendChild(table);
      }

      async function updateOrderStatus(orderId, supplierId, status) {
        if (isNaN(supplierId)) {
          console.error("Invalid supplier ID format");
          return;
        }

        const confirmMessage =
          status === "Accepted"
            ? "Are you sure you want to accept this order?"
            : "Are you sure you want to reject this order?";

        if (!confirm(confirmMessage)) {
          return;
        }

        try {
          const response = await fetch(
            "http://localhost:5000/api/suppliers/orders/respond",
            {
              method: "PUT",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify({
                order_id: orderId,
                supplierId: Number(supplierId),
                status: status,
              }),
            }
          );

          if (!response.ok) throw new Error("Server error");

          alert("Order updated successfully!");
          location.reload();
        } catch (error) {
          console.error("Error updating order:", error);
          alert("Failed to update order.");
        }
      }

      document.getElementById("logout").addEventListener("click", () => {
        sessionStorage.clear();
        window.location.href = "login.html";
      });
    </script>
  </body>
</html>
