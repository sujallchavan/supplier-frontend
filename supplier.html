<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Supplier Dashboard</title>
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"
    />
    <style>
      /* Customer Details Modal Styles */
      .customer-details {
        padding: 0 10px;
      }

      .customer-header {
        display: flex;
        align-items: center;
        margin-bottom: 20px;
        padding-bottom: 20px;
        border-bottom: 1px solid #eee;
      }

      .customer-avatar {
        width: 60px;
        height: 60px;
        background-color: #4e73df;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        margin-right: 15px;
      }

      .customer-avatar i {
        font-size: 30px;
        color: white;
      }

      .customer-info h3 {
        margin: 0;
        color: #2e59d9;
        font-size: 1.5rem;
      }

      .customer-info p {
        margin: 5px 0 0;
        color: #6c757d;
      }

      .detail-section {
        margin-bottom: 25px;
      }

      .detail-section h4 {
        color: #4e73df;
        margin-bottom: 15px;
        display: flex;
        align-items: center;
      }

      .detail-section h4 i {
        margin-right: 8px;
      }

      .detail-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
        gap: 15px;
      }

      .detail-item {
        background: #f8f9fc;
        padding: 12px;
        border-radius: 5px;
      }

      .detail-label {
        display: block;
        font-weight: 600;
        color: #5a5c69;
        margin-bottom: 5px;
        font-size: 0.85rem;
      }

      .detail-value {
        color: #858796;
        font-size: 1rem;
      }

      .stats-grid {
        display: grid;
        grid-template-columns: repeat(3, 1fr);
        gap: 15px;
      }

      .stat-item {
        background: #f8f9fc;
        padding: 15px;
        border-radius: 5px;
        text-align: center;
      }

      .stat-value {
        font-size: 1.5rem;
        font-weight: 700;
        color: #4e73df;
        margin-bottom: 5px;
      }

      .stat-label {
        color: #858796;
        font-size: 0.85rem;
      }

      .activity-list {
        list-style-type: none;
        padding: 0;
        margin: 0;
      }

      .activity-list li {
        padding: 8px 0;
        border-bottom: 1px solid #eee;
        color: #5a5c69;
      }

      .activity-list li:last-child {
        border-bottom: none;
      }

      .btn-view {
        padding: 5px 10px;
        font-size: 0.8rem;
      }

      /* Responsive adjustments */
      @media (max-width: 768px) {
        .detail-grid {
          grid-template-columns: 1fr;
        }

        .stats-grid {
          grid-template-columns: 1fr;
        }
      }
      :root {
        --primary-color: #4e73df;
        --secondary-color: #f8f9fc;
        --accent-color: #2e59d9;
        --text-color: #5a5c69;
        --light-gray: #dddfeb;
        --success-color: #1cc88a;
        --danger-color: #e74a3b;
        --warning-color: #f6c23e;
      }

      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      body {
        font-family: "Nunito", -apple-system, BlinkMacSystemFont, "Segoe UI",
          Roboto, "Helvetica Neue", Arial, sans-serif;
        background-color: #f8f9fc;
        color: var(--text-color);
        min-height: 100vh;
        display: flex;
        overflow-x: hidden;
      }

      /* Sidebar Styles */
      .sidebar {
        width: 250px;
        background: linear-gradient(
          180deg,
          var(--primary-color) 10%,
          rgba(78, 115, 223, 0.9) 100%
        );
        color: white;
        min-height: 100vh;
        transition: all 0.3s;
        position: fixed;
        z-index: 1000;
      }

      .sidebar-header {
        padding: 1.5rem 1.5rem 0.5rem;
        font-weight: 800;
        font-size: 1.2rem;
        text-align: center;
        border-bottom: 1px solid rgba(255, 255, 255, 0.2);
      }

      .sidebar-menu {
        padding: 0 1rem;
      }

      .nav-item {
        margin: 0.5rem 0;
      }

      .nav-link {
        color: rgba(255, 255, 255, 0.8);
        padding: 0.75rem 1rem;
        display: flex;
        align-items: center;
        border-radius: 0.35rem;
        text-decoration: none;
        transition: all 0.3s;
      }

      .nav-link:hover,
      .nav-link.active {
        color: white;
        background-color: rgba(255, 255, 255, 0.1);
      }

      .nav-link i {
        margin-right: 0.5rem;
        font-size: 0.85rem;
      }

      /* Main Content Styles */
      .main-content {
        flex: 1;
        margin-left: 250px;
        transition: all 0.3s;
        min-width: 0; /* Fix flexbox overflow issue */
      }

      .topbar {
        height: 4.375rem;
        box-shadow: 0 0.15rem 1.75rem 0 rgba(58, 59, 69, 0.15);
        background-color: white;
        padding: 0 1.5rem;
        display: flex;
        align-items: center;
        justify-content: space-between;
        position: sticky;
        top: 0;
        z-index: 100;
      }

      .topbar h1 {
        font-size: 1.5rem;
        font-weight: 700;
        color: var(--text-color);
        margin: 0;
        white-space: nowrap;
      }

      .user-info {
        display: flex;
        align-items: center;
        cursor: pointer;
        position: relative;
        white-space: nowrap;
      }

      .user-info img {
        width: 40px;
        height: 40px;
        border-radius: 50%;
        margin-right: 10px;
        object-fit: cover;
      }

      .user-info .user-icon {
        font-size: 1.5rem;
        color: var(--primary-color);
      }

      .container-fluid {
        padding: 1.5rem;
      }

      /* Card Styles */
      .card {
        border: none;
        border-radius: 0.35rem;
        box-shadow: 0 0.15rem 1.75rem 0 rgba(58, 59, 69, 0.1);
        margin-bottom: 1.5rem;
        background-color: white;
        overflow: hidden;
      }

      .card-header {
        background-color: #f8f9fc;
        border-bottom: 1px solid #e3e6f0;
        padding: 1rem 1.35rem;
        font-weight: 700;
        color: var(--text-color);
        border-radius: 0.35rem 0.35rem 0 0 !important;
      }

      .card-body {
        padding: 1.5rem;
        overflow-x: auto;
      }

      /* Table Styles */
      .table {
        width: 100%;
        margin-bottom: 1rem;
        color: var(--text-color);
        border-collapse: collapse;
        min-width: 600px; /* Minimum width for tables */
      }

      .table th {
        background-color: #f8f9fc;
        padding: 0.75rem;
        vertical-align: top;
        border-top: 1px solid #e3e6f0;
        text-align: left;
        font-weight: 700;
        white-space: nowrap;
      }

      .table td {
        padding: 0.75rem;
        vertical-align: top;
        border-top: 1px solid #e3e6f0;
        white-space: nowrap;
      }

      /* Button Styles */
      .btn {
        display: inline-block;
        font-weight: 400;
        text-align: center;
        white-space: nowrap;
        vertical-align: middle;
        user-select: none;
        border: 1px solid transparent;
        padding: 0.375rem 0.75rem;
        font-size: 0.875rem;
        line-height: 1.5;
        border-radius: 0.35rem;
        transition: all 0.15s ease-in-out;
        cursor: pointer;
      }

      .btn-success {
        color: white;
        background-color: var(--success-color);
        border-color: var(--success-color);
      }

      .btn-success:hover {
        background-color: #17a673;
        border-color: #169b6b;
      }

      .btn-danger {
        color: white;
        background-color: var(--danger-color);
        border-color: var(--danger-color);
      }

      .btn-danger:hover {
        background-color: #d62c1a;
        border-color: #c52717;
      }

      .btn-primary {
        color: white;
        background-color: var(--primary-color);
        border-color: var(--primary-color);
      }

      .btn-primary:hover {
        background-color: #3a56c8;
        border-color: #2e4bbf;
      }

      .btn-logout {
        color: white;
        background-color: var(--danger-color);
        border-color: var(--danger-color);
        padding: 0.5rem 1rem;
      }

      /* Supplier Info Styles */
      .supplier-info {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
        gap: 1.5rem;
        margin-bottom: 1.5rem;
      }

      .info-item {
        background-color: white;
        border-radius: 0.35rem;
        padding: 1.5rem;
        box-shadow: 0 0.15rem 1.75rem 0 rgba(58, 59, 69, 0.1);
      }

      .info-item h3 {
        font-size: 1rem;
        color: var(--text-color);
        margin-bottom: 0.5rem;
        font-weight: 700;
      }

      .info-item p {
        font-size: 1.25rem;
        font-weight: 600;
        color: var(--primary-color);
        margin: 0;
      }

      /* Modal Styles */
      .modal {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0, 0, 0, 0.5);
        z-index: 2000;
        justify-content: center;
        align-items: center;
      }

      .modal-content {
        background-color: white;
        border-radius: 0.5rem;
        width: 90%;
        max-width: 600px;
        max-height: 90vh;
        box-shadow: 0 0.5rem 1rem rgba(0, 0, 0, 0.15);
        overflow: hidden;
        animation: modalFadeIn 0.3s;
        display: flex;
        flex-direction: column;
      }

      @keyframes modalFadeIn {
        from {
          opacity: 0;
          transform: translateY(-20px);
        }
        to {
          opacity: 1;
          transform: translateY(0);
        }
      }

      .modal-header {
        background-color: var(--primary-color);
        color: white;
        padding: 1rem 1.5rem;
        display: flex;
        justify-content: space-between;
        align-items: center;
      }

      .modal-header h3 {
        margin: 0;
        font-size: 1.25rem;
      }

      .modal-close {
        background: none;
        border: none;
        color: white;
        font-size: 1.5rem;
        cursor: pointer;
      }

      .modal-body {
        padding: 1.5rem;
        overflow-y: auto;
        flex: 1;
      }

      .modal-footer {
        padding: 1rem 1.5rem;
        background-color: #f8f9fc;
        border-top: 1px solid #e3e6f0;
        display: flex;
        justify-content: flex-end;
      }

      /* Order Details Modal Styles */
      .order-details {
        display: grid;
        grid-template-columns: 1fr;
        gap: 1rem;
      }

      .detail-group {
        margin-bottom: 1rem;
        padding: 1rem;
        background-color: #f8f9fc;
        border-radius: 0.35rem;
      }

      .detail-group h4 {
        margin-bottom: 0.5rem;
        color: var(--primary-color);
        font-size: 1rem;
      }

      .detail-group p {
        margin: 0.25rem 0;
      }

      /* Status Badges */
      .badge {
        display: inline-block;
        padding: 0.35em 0.65em;
        font-size: 0.75em;
        font-weight: 700;
        line-height: 1;
        text-align: center;
        white-space: nowrap;
        vertical-align: baseline;
        border-radius: 0.25rem;
      }

      .badge-primary {
        color: #fff;
        background-color: var(--primary-color);
      }

      .badge-success {
        color: #fff;
        background-color: var(--success-color);
      }

      .badge-danger {
        color: #fff;
        background-color: var(--danger-color);
      }

      .badge-warning {
        color: #1f2d3d;
        background-color: var(--warning-color);
      }

      /* No Data Message */
      .no-data {
        text-align: center;
        padding: 2rem;
        color: var(--text-color);
        font-style: italic;
      }

      /* Responsive Styles */
      @media (max-width: 992px) {
        .sidebar {
          margin-left: -250px;
        }

        .main-content {
          margin-left: 0;
        }

        .sidebar.active {
          margin-left: 0;
        }

        .main-content.active {
          margin-left: 250px;
        }

        .topbar h1 {
          font-size: 1.2rem;
        }
      }

      @media (max-width: 768px) {
        .supplier-info {
          grid-template-columns: 1fr;
        }

        .modal-content {
          width: 95%;
        }

        .order-details {
          grid-template-columns: 1fr;
        }

        .card-body {
          padding: 1rem;
        }

        .container-fluid {
          padding: 1rem;
        }
      }

      /* Toggle Button for Mobile */
      .sidebar-toggle {
        display: none;
        background: none;
        border: none;
        font-size: 1.5rem;
        color: var(--text-color);
        cursor: pointer;
        margin-right: 1rem;
      }

      @media (max-width: 992px) {
        .sidebar-toggle {
          display: block;
        }
      }

      /* Scrollbar styling */
      ::-webkit-scrollbar {
        width: 8px;
        height: 8px;
      }

      ::-webkit-scrollbar-track {
        background: #f1f1f1;
      }

      ::-webkit-scrollbar-thumb {
        background: #888;
        border-radius: 4px;
      }

      ::-webkit-scrollbar-thumb:hover {
        background: #555;
      }
    </style>
  </head>
  <body>
    <!-- Sidebar -->
    <div class="sidebar" id="sidebar">
      <div class="sidebar-header">
        <span>Supplier Portal</span>
      </div>
      <div class="sidebar-menu">
        <div class="nav-item">
          <a href="#" class="nav-link active">
            <i class="fas fa-fw fa-tachometer-alt"></i>
            <span>Dashboard</span>
          </a>
        </div>
        <div class="nav-item">
          <a href="order.html" class="nav-link">
            <i class="fas fa-fw fa-clipboard-list"></i>
            <span>Orders</span>
          </a>
        </div>
        <div class="nav-item">
          <a href="#" class="nav-link">
            <i class="fas fa-fw fa-check-circle"></i>
            <span>Accepted Orders</span>
          </a>
        </div>
        <div class="nav-item">
          <a href="#" class="nav-link">
            <i class="fas fa-fw fa-times-circle"></i>
            <span>Rejected Orders</span>
          </a>
        </div>
        <div class="nav-item">
          <a href="#" class="nav-link">
            <i class="fas fa-fw fa-user-check"></i>
            <span>Assigned Orders</span>
          </a>
        </div>
        <div class="nav-item">
          <a href="#" class="nav-link">
            <i class="fas fa-fw fa-cog"></i>
            <span>Settings</span>
          </a>
        </div>
        <div class="nav-item">
          <button
            id="logout"
            class="nav-link btn-logout"
            style="width: 100%; text-align: left"
          >
            <i class="fas fa-fw fa-sign-out-alt"></i>
            <span>Logout</span>
          </button>
        </div>
      </div>
    </div>

    <!-- Main Content -->
    <div class="main-content" id="main-content">
      <!-- Topbar -->
      <nav class="topbar">
        <button class="sidebar-toggle" id="sidebarToggle">
          <i class="fas fa-bars"></i>
        </button>
        <h1>Supplier Dashboard</h1>
        <div class="user-info" id="userInfoTop">
          <span>Loading...</span>
        </div>
      </nav>

      <!-- Page Content -->
      <div class="container-fluid">
        <!-- Supplier Information -->
        <div class="card mb-4">
          <div class="card-header">
            <h2>Supplier Information</h2>
          </div>
          <div class="card-body">
            <div class="supplier-info" id="supplierInfo">
              <!-- Dynamically filled by JavaScript -->
            </div>
          </div>
        </div>

        <!-- Add this after the Supplier Information card -->
        <div class="card mb-4">
          <div class="card-header">
            <h2>Order Statistics</h2>
          </div>
          <div class="card-body">
            <div class="supplier-info" id="orderStats">
              <!-- Will be filled dynamically -->
            </div>
          </div>
        </div>

        <!-- Customer Orders -->
        <div class="card mb-4">
          <div class="card-header">
            <h2>Customer Orders</h2>
          </div>
          <div class="card-body">
            <div id="orders">
              <p>Fetching orders...</p>
            </div>
          </div>
        </div>
        <!-- Customers Working With You -->
        <div class="card mb-4">
          <div class="card-header">
            <h2>Customers Working With You</h2>
          </div>
          <div class="card-body">
            <div id="customersWorking">
              <p>Fetching customer details...</p>
            </div>
          </div>
        </div>

        <!-- Assigned Orders -->
        <div class="card mb-4">
          <div class="card-header">
            <h2>Orders Assigned to You</h2>
          </div>
          <div class="card-body">
            <div id="assignedOrders">
              <p>Fetching assigned orders...</p>
            </div>
          </div>
        </div>

        <!-- Accepted Orders -->
        <div class="card mb-4">
          <div class="card-header">
            <h2>Accepted Orders</h2>
          </div>
          <div class="card-body">
            <div id="acceptedOrders">
              <p>Fetching accepted orders...</p>
            </div>
          </div>
        </div>

        <!-- Rejected Orders -->
        <div class="card mb-4">
          <div class="card-header">
            <h2>Rejected Orders</h2>
          </div>
          <div class="card-body">
            <div id="rejectedOrders">
              <p>Fetching rejected orders...</p>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- User Profile Modal -->
    <div class="modal" id="userModal">
      <div class="modal-content">
        <div class="modal-header">
          <h3>Supplier Profile</h3>
          <button class="modal-close" id="modalClose">&times;</button>
        </div>
        <div class="modal-body" id="modalBody">
          <!-- Dynamically filled by JavaScript -->
        </div>
        <div class="modal-footer">
          <button class="btn btn-logout" id="modalLogout">
            <i class="fas fa-sign-out-alt"></i> Logout
          </button>
        </div>
      </div>
    </div>

    <!-- Order Details Modal -->
    <div class="modal" id="orderModal">
      <div class="modal-content">
        <div class="modal-header">
          <h3>Order Details</h3>
          <button class="modal-close" id="orderModalClose">&times;</button>
        </div>
        <div class="modal-body" id="orderModalBody">
          <!-- Dynamically filled by JavaScript -->
        </div>
        <div class="modal-footer">
          <button class="btn btn-primary" id="closeOrderModal">Close</button>
        </div>
      </div>
    </div>

    <!-- <script>
        // Toggle sidebar on mobile
        document.getElementById("sidebarToggle").addEventListener("click", function() {
            document.getElementById("sidebar").classList.toggle("active");
            document.getElementById("main-content").classList.toggle("active");
        });

        // Close sidebar when clicking outside on mobile
        document.addEventListener("click", function(event) {
            const sidebar = document.getElementById("sidebar");
            const mainContent = document.getElementById("main-content");
            const toggleBtn = document.getElementById("sidebarToggle");
            
            if (window.innerWidth <= 992 && 
                !sidebar.contains(event.target) && 
                !toggleBtn.contains(event.target) &&
                sidebar.classList.contains("active")) {
                
                sidebar.classList.remove("active");
                mainContent.classList.remove("active");
            }
        });

        // Rest of your existing JavaScript code...
        // (Keep all your existing functions like fetchOrders, viewOrderDetails, etc.)
        
        // Initialize the page
        document.addEventListener("DOMContentLoaded", function() {
            const supplierData = sessionStorage.getItem("supplier");
            
            if (supplierData) {
                const supplier = JSON.parse(supplierData);
                // Your existing initialization code...
            } else {
                window.location.href = "login.html";
            }
        });
    </script> -->

    <script>
      // Toggle sidebar on mobile
      document
        .getElementById("sidebarToggle")
        .addEventListener("click", function () {
          document.getElementById("sidebar").classList.toggle("active");
          document.getElementById("main-content").classList.toggle("active");
        });

      // Modal functionality
      const userModal = document.getElementById("userModal");
      const modalClose = document.getElementById("modalClose");
      const modalLogout = document.getElementById("modalLogout");

      const orderModal = document.getElementById("orderModal");
      const orderModalClose = document.getElementById("orderModalClose");
      const closeOrderModal = document.getElementById("closeOrderModal");

      // Open modal when clicking user info
      document
        .getElementById("userInfoTop")
        .addEventListener("click", function () {
          userModal.style.display = "flex";
          document.body.style.overflow = "hidden"; // Prevent scrolling when modal is open
        });

      // Close modal when clicking close button
      modalClose.addEventListener("click", function () {
        userModal.style.display = "none";
        document.body.style.overflow = "auto";
      });

      // Close order modal when clicking close button
      orderModalClose.addEventListener("click", function () {
        orderModal.style.display = "none";
        document.body.style.overflow = "auto";
      });

      closeOrderModal.addEventListener("click", function () {
        orderModal.style.display = "none";
        document.body.style.overflow = "auto";
      });

      // Close modal when clicking outside
      userModal.addEventListener("click", function (e) {
        if (e.target === userModal) {
          userModal.style.display = "none";
          document.body.style.overflow = "auto";
        }
      });

      // Close order modal when clicking outside
      orderModal.addEventListener("click", function (e) {
        if (e.target === orderModal) {
          orderModal.style.display = "none";
          document.body.style.overflow = "auto";
        }
      });

      // Logout from modal
      modalLogout.addEventListener("click", function () {
        sessionStorage.clear();
        window.location.href = "login.html";
      });

      const supplierData = sessionStorage.getItem("supplier");

      if (supplierData) {
        const supplier = JSON.parse(supplierData);

        // Update top user info
        document.getElementById("userInfoTop").innerHTML = `
                <i class="fas fa-user-circle user-icon"></i>
                <span>${supplier.name}</span>
              `;

        // Update modal content
        document.getElementById("modalBody").innerHTML = `
                <div class="modal-profile">
                  <div class="modal-profile-img">
                    <i class="fas fa-user-tie"></i>
                  </div>
                  <div class="modal-profile-info">
                    <h4>${supplier.name}</h4>
                    <p>${supplier.companyName || "No Company"}</p>
                    <p>${supplier.category || "No Category"}</p>
                  </div>
                </div>
                <div class="modal-details">
                  <div class="modal-detail-item">
                    <h5>Supplier ID</h5>
                    <p>${supplier.supplierId}</p>
                  </div>
                  <div class="modal-detail-item">
                    <h5>Email</h5>
                    <p>${supplier.email}</p>
                  </div>
                  <div class="modal-detail-item">
                    <h5>Phone</h5>
                    <p>${supplier.phoneNumber || "N/A"}</p>
                  </div>
                  <div class="modal-detail-item">
                    <h5>Location</h5>
                    <p>${supplier.location || "N/A"}</p>
                  </div>
                </div>
              `;

        // Update supplier info cards
        document.getElementById("supplierInfo").innerHTML = `
                <div class="info-item">
                  <h3>Supplier ID</h3>
                  <p>${supplier.supplierId}</p>
                </div>
                <div class="info-item">
                  <h3>Name</h3>
                  <p>${supplier.name}</p>
                </div>
                <div class="info-item">
                  <h3>Email</h3>
                  <p>${supplier.email}</p>
                </div>
                <div class="info-item">
                  <h3>Phone</h3>
                  <p>${supplier.phoneNumber || "N/A"}</p>
                </div>
                <div class="info-item">
                  <h3>Company</h3>
                  <p>${supplier.companyName || "N/A"}</p>
                </div>
                <div class="info-item">
                  <h3>Category</h3>
                  <p>${supplier.category || "N/A"}</p>
                </div>
                <div class="info-item">
                  <h3>Address</h3>
                  <p>${supplier.location || "N/A"}</p>
                </div>
              `;

        fetchOrders(supplier);
      } else {
        document.getElementById("supplierInfo").innerHTML = `
                <div class="info-item" style="grid-column: 1 / -1;">
                  <h3>Error</h3>
                  <p>Not logged in!</p>
                </div>
              `;
        window.location.href = "login.html";
      }

      function fetchOrders(supplier) {
        fetch(
          `https://backend-api-3qcm.onrender.com/api/suppliers/orders?category=${supplier.category}`
        )
          .then((response) => response.json())
          .then((orders) => {
            const ordersContainer = document.getElementById("orders");
            ordersContainer.innerHTML = "";

            // Filter only orders that are approved
            let approvedOrders = orders.filter(
              (order) => order.isApproved === "Approved"
            );

            // Exclude orders that are already accepted or rejected
            let pendingOrders = approvedOrders.filter(
              (order) =>
                !order.supplierResponses ||
                !order.supplierResponses.some(
                  (response) =>
                    response.supplier_Id === supplier.supplierId &&
                    (response.status === "Accepted" ||
                      response.status === "Rejected")
                )
            );

            // Additional filter for working_status - exclude Completed and Working
            pendingOrders = pendingOrders.filter(
              (order) =>
                order.working_status !== "Completed" &&
                order.working_status !== "Working"
            );

            if (pendingOrders.length === 0) {
              ordersContainer.innerHTML =
                '<div class="no-data">No pending orders available (excluding Completed and Working status).</div>';
              fetchAssignedOrders(supplier, orders);
              fetchAcceptedOrders(supplier, approvedOrders);
              fetchRejectedOrders(supplier, approvedOrders);
              return;
            }

            const table = document.createElement("table");
            table.className = "table";
            table.innerHTML = `
                <thead>
                    <tr>
                        <th>Order ID</th>
                        <th>Customer</th>
                        <th>Part</th>
                        <th>Category</th>
                        <th>Status</th>
                        <th>Description</th>
                        <th>Quantity</th>
                        <th>Price</th>
                        <th>Approval Status</th>
                        <th>Action</th>
                    </tr>
                </thead>
                <tbody id="ordersTableBody">
                </tbody>
            `;

            const tbody = document.createElement("tbody");
            pendingOrders.forEach((order) => {
              const row = document.createElement("tr");

              // Create all cells except the action buttons
              row.innerHTML = `
                  <td>${order.order_id}</td>
                  <td>${order.cname} (${order.email})</td>
                  <td>${order.Part_Name}</td>
                  <td>${order.category}</td>
                  <td><span class="badge ${
                    order.working_status === "Completed"
                      ? "badge-success"
                      : order.working_status === "Working"
                      ? "badge-primary"
                      : "badge-warning"
                  }">${order.working_status}</span></td>
                  <td>${order.desc}</td>
                  <td>${order.tv}</td>
                  <td>${order.pr}</td>
                  <td><span class="badge ${
                    order.isApproved === "Approved"
                      ? "badge-success"
                      : "badge-danger"
                  }">${order.isApproved}</span></td>
                  <td></td> <!-- Empty cell for buttons -->
              `;

              // Create action buttons
              const actionCell = row.cells[row.cells.length - 1];

              // Accept button
              const acceptBtn = document.createElement("button");
              acceptBtn.className = "btn btn-success btn-sm";
              acceptBtn.textContent = "Accept";
              acceptBtn.onclick = () =>
                updateOrderStatus(
                  order.order_id,
                  supplier.supplierId,
                  "Accepted"
                );
              actionCell.appendChild(acceptBtn);

              // Space between buttons
              actionCell.appendChild(document.createTextNode(" "));

              // Reject button
              const rejectBtn = document.createElement("button");
              rejectBtn.className = "btn btn-danger btn-sm";
              rejectBtn.textContent = "Reject";
              rejectBtn.onclick = () =>
                updateOrderStatus(
                  order.order_id,
                  supplier.supplierId,
                  "Rejected"
                );
              actionCell.appendChild(rejectBtn);

              // Space between buttons
              actionCell.appendChild(document.createTextNode(" "));

              // View button
              const viewBtn = document.createElement("button");
              viewBtn.className = "btn btn-info btn-sm";
              viewBtn.textContent = "View";
              viewBtn.onclick = () => showFullOrderDetails(order);
              actionCell.appendChild(viewBtn);

              tbody.appendChild(row);
            });

            table.appendChild(tbody);
            ordersContainer.appendChild(table);
            fetchAssignedOrders(supplier, orders);
            fetchAcceptedOrders(supplier, approvedOrders);
            fetchRejectedOrders(supplier, approvedOrders);
            displayOrderStats(orders, supplier);
            fetchCustomersWorkingWithSupplier(supplier);
          })
          .catch((error) => {
            console.error("Error fetching orders:", error);
            document.getElementById("orders").innerHTML =
              '<div class="no-data">Failed to fetch orders. Please try again later.</div>';
          });
      }

      // Add this new function to show full order details
      window.showFullOrderDetails = function (order) {
        // Format dates for display
        const formatDate = (dateString) => {
          if (!dateString) return "Not specified";
          try {
            const date = new Date(dateString);
            return isNaN(date.getTime())
              ? dateString
              : date.toLocaleDateString();
          } catch (e) {
            return dateString;
          }
        };

        // Create modal content with all order details
        const modalContent = `
          <div class="order-details">
              <div class="detail-group">
                  <h4>Order Information</h4>
                  <p><strong>Order ID:</strong> ${order.order_id || "N/A"}</p>
                  <p><strong>Status:</strong> <span class="badge ${
                    order.working_status === "Completed"
                      ? "badge-success"
                      : order.working_status === "Working"
                      ? "badge-primary"
                      : "badge-warning"
                  }">${order.working_status || "N/A"}</span></p>
                  <p><strong>Approval Status:</strong> <span class="badge ${
                    order.isApproved === "Approved"
                      ? "badge-success"
                      : "badge-danger"
                  }">${order.isApproved || "N/A"}</span></p>
                  <p><strong>Created At:</strong> ${formatDate(
                    order.createdAt
                  )}</p>
              </div>
              
              <div class="detail-group">
                  <h4>Part Details</h4>
                  <p><strong>Part Name:</strong> ${order.Part_Name || "N/A"}</p>
                  <p><strong>Blank Name:</strong> ${
                    order.blank_name || "N/A"
                  }</p>
                  <p><strong>Category:</strong> ${order.category || "N/A"}</p>
                  <p><strong>Description:</strong> ${order.desc || "N/A"}</p>
                  <p><strong>Quantity:</strong> ${order.tv || "N/A"}</p>
                  <p><strong>Price:</strong> ${order.pr || "N/A"}</p>
                  <p><strong>Available Volume:</strong> ${order.av || "N/A"}</p>
              </div>
              
              <div class="detail-group">
                  <h4>Customer Information</h4>
                  <p><strong>Name:</strong> ${order.cname || "N/A"}</p>
                  <p><strong>Email:</strong> ${order.email || "N/A"}</p>
                  <p><strong>Phone:</strong> ${order.phone_number || "N/A"}</p>
                  <p><strong>Customer Part No.:</strong> ${
                    order.cpno || "N/A"
                  }</p>
                  <p><strong>Location:</strong> ${order.location || "N/A"}</p>
              </div>
              
              <div class="detail-group">
                  <h4>Timeline</h4>
                  <p><strong>Quote Submission Date:</strong> ${formatDate(
                    order.qs
                  )}</p>
                  <p><strong>Start of Production:</strong> ${formatDate(
                    order.sop
                  )}</p>
              </div>
              
              ${
                order.pdf_file
                  ? `
              <div class="detail-group">
                  <h4>Attachments</h4>
                  <a href="${order.pdf_file}" target="_blank" class="btn btn-primary">
                      <i class="fas fa-file-pdf"></i> View PDF
                  </a>
              </div>
              `
                  : ""
              }
              
              <div class="detail-group">
                  <h4>Supplier Responses</h4>
                  ${
                    order.supplierResponses &&
                    order.supplierResponses.length > 0
                      ? `<table class="table table-sm">
                          <thead>
                              <tr>
                                  <th>Supplier ID</th>
                                  <th>Status</th>
                                  <th>Date</th>
                              </tr>
                          </thead>
                          <tbody>
                              ${order.supplierResponses
                                .map(
                                  (response) => `
                                  <tr>
                                      <td>${response.supplier_Id || "N/A"}</td>
                                      <td><span class="badge ${
                                        response.status === "Accepted"
                                          ? "badge-success"
                                          : response.status === "Rejected"
                                          ? "badge-danger"
                                          : "badge-warning"
                                      }">${response.status || "N/A"}</span></td>
                                      <td>${formatDate(response.date)}</td>
                                  </tr>
                              `
                                )
                                .join("")}
                          </tbody>
                      </table>`
                      : "<p>No supplier responses yet</p>"
                  }
              </div>
              
              ${
                order.acceptedSupplier
                  ? `<div class="detail-group">
                      <h4>Assigned Supplier</h4>
                      <p><strong>Supplier ID:</strong> ${
                        order.acceptedSupplier.supplier_Id || "N/A"
                      }</p>
                      <p><strong>Assigned At:</strong> ${formatDate(
                        order.acceptedSupplier.acceptedAt
                      )}</p>
                  </div>`
                  : ""
              }
          </div>
        `;

        // Set modal content and show
        document.getElementById("orderModalBody").innerHTML = modalContent;
        document.getElementById("orderModal").style.display = "flex";
        document.body.style.overflow = "hidden";

        // Update modal title
        document.querySelector(
          "#orderModal .modal-header h3"
        ).textContent = `Order #${order.order_id} Details`;
      };

      async function fetchCustomersWorkingWithSupplier(supplier) {
        try {
          // First get all assigned orders to this supplier
          const ordersResponse = await fetch(
            `https://backend-api-3qcm.onrender.com/api/suppliers/orders?category=${supplier.category}`
          );

          // Check if orders response is JSON
          const ordersContentType = ordersResponse.headers.get("content-type");
          if (
            !ordersContentType ||
            !ordersContentType.includes("application/json")
          ) {
            const text = await ordersResponse.text();
            throw new Error(
              `Orders API returned non-JSON: ${text.substring(0, 100)}...`
            );
          }

          const orders = await ordersResponse.json();

          // Filter orders assigned to this supplier
          const assignedOrders = orders.filter(
            (order) =>
              order.isSupplierAccepted &&
              order.acceptedSupplier?.supplier_Id === supplier.supplierId
          );

          // Get unique customer emails from these orders
          const customerEmails = [
            ...new Set(assignedOrders.map((order) => order.email)),
          ];

          if (customerEmails.length === 0) {
            document.getElementById("customersWorking").innerHTML =
              '<div class="no-data">No customers found who are working with you.</div>';
            return;
          }

          // Fetch customer details
          const customersResponse = await fetch(
            "https://backend-api-3qcm.onrender.com/api/suppliers/customers",
            {
              method: "POST",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify({ emails: customerEmails }),
            }
          );

          // Check if customers response is JSON
          const customersContentType =
            customersResponse.headers.get("content-type");
          if (
            !customersContentType ||
            !customersContentType.includes("application/json")
          ) {
            const text = await customersResponse.text();
            throw new Error(
              `Customers API returned non-JSON: ${text.substring(0, 100)}...`
            );
          }

          const result = await customersResponse.json();

          if (!result.success || !result.data) {
            throw new Error(
              result.message || "Failed to fetch customer details"
            );
          }

          const customers = result.data;
          const customersContainer =
            document.getElementById("customersWorking");
          customersContainer.innerHTML = "";

          if (!customers || customers.length === 0) {
            customersContainer.innerHTML =
              '<div class="no-data">No customer details found.</div>';
            return;
          }

          const table = document.createElement("table");
          table.className = "table";
          table.innerHTML = `
      <thead>
        <tr>
          <th>Customer ID</th>
          <th>Name</th>
          <th>Email</th>
          <th>Phone</th>
          <th>Location</th>
          <th>Orders Count</th>
          <th>View Details</th>
        </tr>
      </thead>
      <tbody id="customersTableBody"></tbody>
    `;

          const tbody = document.createElement("tbody");
          customers.forEach((customer) => {
            const orderCount = assignedOrders.filter(
              (order) => order.email === customer.email
            ).length;

            const row = document.createElement("tr");
            row.innerHTML = `
  <td>${customer.customer_id || "N/A"}</td>
  <td>${customer.name || "N/A"}</td>
  <td>${customer.email || "N/A"}</td>
  <td>${customer.phone_number || "N/A"}</td>
  <td>${customer.location || "N/A"}</td>
  <td>${orderCount}</td>
  <td>
    <button class="btn btn-primary btn-view" 
            onclick="viewCustomerDetails('${customer.customer_id}')"
            data-customer='${JSON.stringify(customer).replace(/'/g, "\\'")}'
            data-orders='${orderCount}'>
      <i class="fas fa-eye"></i> View
    </button>
  </td>
`;
            tbody.appendChild(row);
          });

          table.appendChild(tbody);
          customersContainer.appendChild(table);
        } catch (error) {
          console.error("Error fetching customers:", error);
          document.getElementById("customersWorking").innerHTML = `
      <div class="no-data">Error: ${error.message}</div>
    `;
        }
      }

      // View Customer Details Modal
      function viewCustomerDetails(customerId) {
        const button = document.querySelector(
          `button[onclick="viewCustomerDetails('${customerId}')"]`
        );
        const customer = JSON.parse(button.getAttribute("data-customer"));
        const orderCount = button.getAttribute("data-orders");

        // Create modal content
        const modalContent = `
    <div class="customer-details">
      <div class="customer-header">
        <div class="customer-avatar">
          <i class="fas fa-user-tie"></i>
        </div>
        <div class="customer-info">
          <h3>${customer.name || "No Name"}</h3>
          <p>Customer ID: ${customer.customer_id}</p>
        </div>
      </div>
      
      <div class="detail-section">
        <h4><i class="fas fa-info-circle"></i> Basic Information</h4>
        <div class="detail-grid">
          <div class="detail-item">
            <span class="detail-label">Email:</span>
            <span class="detail-value">${customer.email || "N/A"}</span>
          </div>
          <div class="detail-item">
            <span class="detail-label">Phone:</span>
            <span class="detail-value">${customer.phone_number || "N/A"}</span>
          </div>
          <div class="detail-item">
            <span class="detail-label">Location:</span>
            <span class="detail-value">${customer.location || "N/A"}</span>
          </div>
        </div>
      </div>
      
      <div class="detail-section">
        <h4><i class="fas fa-shopping-cart"></i> Order Statistics</h4>
        <div class="stats-grid">
          <div class="stat-item">
            <div class="stat-value">${orderCount}</div>
            <div class="stat-label">Total Orders</div>
          </div>
          <div class="stat-item">
            <div class="stat-value">${Math.floor(Math.random() * 10) + 1}</div>
            <div class="stat-label">Active Orders</div>
          </div>
          <div class="stat-item">
            <div class="stat-value">${
              Math.floor(Math.random() * 1000) + 100
            }</div>
            <div class="stat-label">Total Spent ($)</div>
          </div>
        </div>
      </div>
      
      <div class="detail-section">
        <h4><i class="fas fa-history"></i> Recent Activity</h4>
        <ul class="activity-list">
          <li>Placed order #${Math.floor(
            Math.random() * 1000
          )} on ${new Date().toLocaleDateString()}</li>
          <li>Updated profile information</li>
          <li>Contacted support</li>
        </ul>
      </div>
    </div>
  `;

        // Set modal content and show
        document.getElementById("orderModalBody").innerHTML = modalContent;
        document.getElementById("orderModal").style.display = "flex";
        document.body.style.overflow = "hidden";

        // Update modal title
        document.querySelector("#orderModal .modal-header h3").textContent =
          "Customer Details";
      }

      function fetchAssignedOrders(supplier, orders) {
        const assignedOrders = orders.filter(
          (order) =>
            order.isSupplierAccepted &&
            order.acceptedSupplier?.supplier_Id === supplier.supplierId
        );

        const assignedOrdersContainer =
          document.getElementById("assignedOrders");
        assignedOrdersContainer.innerHTML = "";

        if (assignedOrders.length === 0) {
          assignedOrdersContainer.innerHTML =
            '<div class="no-data">No orders assigned to you yet.</div>';
          return;
        }

        const table = document.createElement("table");
        table.className = "table";
        table.innerHTML = `
        <thead>
            <tr>
                <th>Order ID</th>
                <th>Customer</th>
                <th>Part</th>
                <th>Category</th>
                <th>Status</th>
                <th>Description</th>
                <th>Quantity</th>
                <th>Price</th>
                <th>Assigned Date</th>
                <th>Final Approval</th>
                <th>Action</th>
            </tr>
        </thead>
        <tbody id="assignedOrdersTableBody">
        </tbody>
    `;

        const tbody = document.createElement("tbody");
        assignedOrders.forEach((order) => {
          const row = document.createElement("tr");
          row.innerHTML = `
            <td>${order.order_id}</td>
            <td>${order.cname} (${order.email})</td>
            <td>${order.Part_Name}</td>
            <td>${order.category}</td>
            <td><span class="badge ${
              order.working_status === "Completed"
                ? "badge-success"
                : order.working_status === "Working"
                ? "badge-primary"
                : "badge-warning"
            }">${order.working_status}</span></td>
            <td>${order.desc}</td>
            <td>${order.tv}</td>
            <td>${order.pr}</td>
            <td>${
              order.acceptedSupplier?.acceptedAt
                ? new Date(order.acceptedSupplier.acceptedAt).toLocaleString()
                : "N/A"
            }</td>
            <td><span class="badge ${
              order.isFinalApproved === "Approved"
                ? "badge-success"
                : "badge-danger"
            }">${order.isFinalApproved || "Disapproved"}</span></td>
            <td>
                <button class="btn btn-primary" onclick="viewOrderDetails('${
                  order.order_id
                }')">View</button>
            </td>
        `;
          tbody.appendChild(row);
        });

        table.appendChild(tbody);
        assignedOrdersContainer.appendChild(table);
      }

      function fetchAcceptedOrders(supplier, orders) {
        const acceptedOrders = orders.filter(
          (order) =>
            order.supplierResponses &&
            order.supplierResponses.some(
              (response) =>
                response.supplier_Id === supplier.supplierId &&
                response.status === "Accepted"
            )
        );

        const acceptedOrdersContainer =
          document.getElementById("acceptedOrders");
        acceptedOrdersContainer.innerHTML = "";

        if (acceptedOrders.length === 0) {
          acceptedOrdersContainer.innerHTML =
            '<div class="no-data">No accepted orders found.</div>';
          return;
        }

        const table = document.createElement("table");
        table.className = "table";
        table.innerHTML = `
          <thead>
            <tr>
              <th>Order ID</th>
              <th>Customer</th>
              <th>Part</th>
              <th>Category</th>
              <th>Status</th>
              <th>Description</th>
              <th>Quantity</th>
              <th>Price</th>
              <th>Supplier ID</th>
              <th>Supplier Responses</th>
              <th>Assignment</th>
              <th>Action</th>
            </tr>
          </thead>
          <tbody id="acceptedOrdersTableBody">
          </tbody>
        `;

        const tbody = document.createElement("tbody");
        acceptedOrders.forEach((order) => {
          const supplierResponse = order.supplierResponses.find(
            (response) => response.supplier_Id === supplier.supplierId
          );

          const isAssignedToCurrentSupplier =
            order.acceptedSupplier &&
            order.acceptedSupplier.supplier_Id === supplier.supplierId;

          const assignmentStatus = isAssignedToCurrentSupplier
            ? `<span class="badge badge-success">Assigned to You</span>`
            : `<span class="badge badge-warning">Assigned to Someone Else</span>`;

          const row = document.createElement("tr");
          row.innerHTML = `
            <td>${order.order_id}</td>
            <td>${order.cname} (${order.email})</td>
            <td>${order.Part_Name}</td>
            <td>${order.category}</td>
            <td><span class="badge ${
              order.working_status === "Completed"
                ? "badge-success"
                : order.working_status === "Working"
                ? "badge-primary"
                : "badge-warning"
            }">${order.working_status}</span></td>
            <td>${order.desc}</td>
            <td>${order.tv}</td>
            <td>${order.pr}</td>
            <td>${supplierResponse.supplier_Id}</td>
            <td><span class="badge badge-success">${
              supplierResponse.status
            }</span></td>
            <td>${assignmentStatus}</td>
            <td>
              <button class="btn btn-primary" onclick="viewAcceptedOrderDetails('${
                order.order_id
              }')">View</button>
            </td>
          `;
          tbody.appendChild(row);
        });

        table.appendChild(tbody);
        acceptedOrdersContainer.appendChild(table);
      }

      function fetchRejectedOrders(supplier, orders) {
        const rejectedOrders = orders.filter(
          (order) =>
            order.supplierResponses &&
            order.supplierResponses.some(
              (response) =>
                response.supplier_Id === supplier.supplierId &&
                response.status === "Rejected"
            )
        );

        const rejectedOrdersContainer =
          document.getElementById("rejectedOrders");
        rejectedOrdersContainer.innerHTML = "";

        if (rejectedOrders.length === 0) {
          rejectedOrdersContainer.innerHTML =
            '<div class="no-data">No rejected orders found.</div>';
          return;
        }

        const table = document.createElement("table");
        table.className = "table";
        table.innerHTML = `
                <thead>
                  <tr>
                    <th>Order ID</th>
                    <th>Customer</th>
                    <th>Part</th>
                    <th>Category</th>
                    <th>Status</th>
                    <th>Description</th>
                    <th>Quantity</th>
                    <th>Price</th>
                    <th>Supplier ID</th>
                    <th>Supplier Responses</th>
                    <th>Action</th>
                  </tr>
                </thead>
                <tbody id="rejectedOrdersTableBody">
                </tbody>
              `;

        const tbody = document.createElement("tbody");
        rejectedOrders.forEach((order) => {
          const supplierResponse = order.supplierResponses.find(
            (response) => response.supplier_Id === supplier.supplierId
          );

          const row = document.createElement("tr");
          row.innerHTML = `
                  <td>${order.order_id}</td>
                  <td>${order.cname} (${order.email})</td>
                  <td>${order.Part_Name}</td>
                  <td>${order.category}</td>
                  <td><span class="badge ${
                    order.working_status === "Completed"
                      ? "badge-success"
                      : order.working_status === "Working"
                      ? "badge-primary"
                      : "badge-warning"
                  }">${order.working_status}</span></td>
                  <td>${order.desc}</td>
                  <td>${order.tv}</td>
                  <td>${order.pr}</td>
                  <td>${supplierResponse.supplier_Id}</td>
                  <td><span class="badge badge-danger">${
                    supplierResponse.status
                  }</span></td>
                  <td>
          <button class="btn btn-primary" onclick="viewRejectedOrderDetails('${
            order.order_id
          }')">View</button>
                `;
          tbody.appendChild(row);
        });

        table.appendChild(tbody);
        rejectedOrdersContainer.appendChild(table);
      }

      function viewOrderDetails(orderId) {
        const supplierData = sessionStorage.getItem("supplier");
        if (!supplierData) {
          alert("Supplier data not found. Please login again.");
          return;
        }

        const supplier = JSON.parse(supplierData);

        // Find the order in assigned orders
        const assignedOrdersContainer =
          document.getElementById("assignedOrders");
        const rows = assignedOrdersContainer.querySelectorAll("tbody tr");

        let order = null;
        for (const row of rows) {
          const rowOrderId = row.cells[0].textContent;
          if (rowOrderId === orderId) {
            order = {
              order_id: rowOrderId,
              cname: row.cells[1].textContent.split(" (")[0],
              email: row.cells[1].textContent.match(/\((.*?)\)/)[1],
              Part_Name: row.cells[2].textContent,
              category: row.cells[3].textContent,
              working_status: row.cells[4].querySelector(".badge").textContent,
              desc: row.cells[5].textContent,
              tv: row.cells[6].textContent,
              pr: row.cells[7].textContent,
              isApproved: "Approved", // Since it's assigned, it must be approved
              isFinalApproved:
                row.cells[9].querySelector(".badge")?.textContent ||
                "Disapproved",
              acceptedSupplier: {
                supplier_Id: supplier.supplierId,
                acceptedAt: row.cells[8].textContent,
              },
            };
            break;
          }
        }

        if (!order) {
          document.getElementById("orderModalBody").innerHTML = `
            <div class="no-data">Order details not found in assigned orders.</div>
        `;
        } else {
          // Create the approval button based on current status
          const approvalButton =
            order.isFinalApproved === "Approved"
              ? `<button class="btn btn-danger" onclick="updateFinalApproval('${order.order_id}', false)">Disapprove</button>`
              : `<button class="btn btn-success" onclick="updateFinalApproval('${order.order_id}', true)">Approve</button>`;

          // Populate the modal with order details
          document.getElementById("orderModalBody").innerHTML = `
            <div class="order-details">
                <div class="detail-group">
                    <h4>Order Information</h4>
                    <p><strong>Order ID:</strong> ${order.order_id}</p>
                    <p><strong>Status:</strong> <span class="badge ${
                      order.working_status === "Completed"
                        ? "badge-success"
                        : order.working_status === "Working"
                        ? "badge-primary"
                        : "badge-warning"
                    }">${order.working_status}</span></p>
                    <p><strong>Approval Status:</strong> <span class="badge badge-success">${
                      order.isApproved
                    }</span></p>
                    <p><strong>Final Approval:</strong> <span class="badge ${
                      order.isFinalApproved === "Approved"
                        ? "badge-success"
                        : "badge-danger"
                    }">${order.isFinalApproved}</span></p>
                </div>
                
                <div class="detail-group">
                    <h4>Part Details</h4>
                    <p><strong>Part Name:</strong> ${order.Part_Name}</p>
                    <p><strong>Category:</strong> ${order.category}</p>
                    <p><strong>Description:</strong> ${order.desc}</p>
                    <p><strong>Quantity:</strong> ${order.tv}</p>
                    <p><strong>Price:</strong> ${order.pr}</p>
                </div>
                
                <div class="detail-group">
                    <h4>Customer Information</h4>
                    <p><strong>Name:</strong> ${order.cname}</p>
                    <p><strong>Email:</strong> ${order.email}</p>
                </div>
                
                <div class="detail-group">
                    <h4>Supplier Assignment</h4>
                    <p><strong>Supplier ID:</strong> ${
                      order.acceptedSupplier.supplier_Id
                    }</p>
                    <p><strong>Assigned At:</strong> ${
                      order.acceptedSupplier.acceptedAt
                    }</p>
                </div>
                
                <div class="detail-group">
                    <h4>Final Approval</h4>
                    ${approvalButton}
                </div>
            </div>
        `;
        }

        // Show the modal
        orderModal.style.display = "flex";
        document.body.style.overflow = "hidden";
      }

      async function updateFinalApproval(orderId, isApproved) {
        if (
          !confirm(
            `Are you sure you want to ${
              isApproved ? "approve" : "disapprove"
            } this order?`
          )
        ) {
          return;
        }

        try {
          // Use the correct backend URL - make sure it matches your deployed backend
          const backendUrl = "https://backend-api-3qcm.onrender.com"; // or your localhost during development
          const response = await fetch(
            `${backendUrl}/api/suppliers/update-final-approval/${orderId}`,
            {
              method: "PUT",
              headers: {
                "Content-Type": "application/json",
              },
              body: JSON.stringify({
                isFinalApproved: isApproved,
              }),
            }
          );

          // First check if response is OK
          if (!response.ok) {
            // Try to parse error response
            let errorData;
            try {
              errorData = await response.json();
            } catch (e) {
              throw new Error(`HTTP error! status: ${response.status}`);
            }
            throw new Error(
              errorData.message || "Failed to update final approval status"
            );
          }

          const result = await response.json();
          if (result.success) {
            alert(
              `Order has been ${
                isApproved ? "approved" : "disapproved"
              } successfully!`
            );
            // Instead of full reload, you could refresh just the order data
            location.reload();
          } else {
            throw new Error(
              result.message || "Failed to update final approval status"
            );
          }
        } catch (error) {
          console.error("Error updating final approval:", error);
          alert(`Error: ${error.message}`);
        }
      }

      function viewAcceptedOrderDetails(orderId) {
        const supplierData = sessionStorage.getItem("supplier");
        if (!supplierData) {
          alert("Supplier data not found. Please login again.");
          return;
        }

        const supplier = JSON.parse(supplierData);
        const acceptedOrdersContainer =
          document.getElementById("acceptedOrders");
        const rows = acceptedOrdersContainer.querySelectorAll("tbody tr");

        let order = null;
        for (const row of rows) {
          const rowOrderId = row.cells[0].textContent;
          if (rowOrderId === orderId) {
            const acceptedSupplierId = row.cells[8].textContent;

            const isAssignedToCurrentSupplier =
              acceptedSupplierId &&
              acceptedSupplierId.toString() === supplier.supplierId.toString();

            const isAssignedToSomeoneElse =
              acceptedSupplierId &&
              acceptedSupplierId.toString() !== supplier.supplierId.toString();

            order = {
              order_id: rowOrderId,
              cname: row.cells[1].textContent.split(" (")[0],
              email: row.cells[1].textContent.match(/\((.*?)\)/)[1],
              Part_Name: row.cells[2].textContent,
              category: row.cells[3].textContent,
              working_status: row.cells[4].querySelector(".badge").textContent,
              desc: row.cells[5].textContent,
              quantity: row.cells[6].textContent,
              price: row.cells[7].textContent,
              isApproved: "Approved",
              acceptedSupplierId: acceptedSupplierId,
              isAssignedToCurrentSupplier,
              isAssignedToSomeoneElse,
            };
            break;
          }
        }

        if (!order) {
          document.getElementById("orderModalBody").innerHTML = `
        <div class="no-data">Order details not found in accepted orders.</div>
      `;
        } else {
          // Assignment status block
          let assignmentStatusHtml = "";
          if (order.isAssignedToCurrentSupplier) {
            assignmentStatusHtml = `
          <div class="detail-group">
              <h4>Assignment Status</h4>
              <p class="text-success"><i class="fas fa-check-circle"></i> This order is assigned to you</p>
          </div>`;
          } else if (order.isAssignedToSomeoneElse) {
            assignmentStatusHtml = `
          <div class="detail-group">
              <h4>Assignment Status</h4>
              <p class="text-warning"><i class="fas fa-exclamation-triangle"></i> This order is assigned to another supplier</p>
          </div>`;
          } else {
            assignmentStatusHtml = `
          <div class="detail-group">
              <h4>Assignment Status</h4>
              <p class="text-info"><i class="fas fa-info-circle"></i> This order is not assigned to any supplier</p>
          </div>`;
          }

          document.getElementById("orderModalBody").innerHTML = `
        <div class="order-details">
            <div class="detail-group">
                <h4>Order Information</h4>
                <p><strong>Order ID:</strong> ${order.order_id}</p>
                <p><strong>Status:</strong> <span class="badge ${
                  order.working_status === "Completed"
                    ? "badge-success"
                    : order.working_status === "Working"
                    ? "badge-primary"
                    : "badge-warning"
                }">${order.working_status}</span></p>
                <p><strong>Approval Status:</strong> <span class="badge badge-success">${
                  order.isApproved
                }</span></p>
            </div>
  
            ${assignmentStatusHtml}
  
            <div class="detail-group">
                <h4>Part Details</h4>
                <p><strong>Part Name:</strong> ${order.Part_Name}</p>
                <p><strong>Category:</strong> ${order.category}</p>
                <p><strong>Description:</strong> ${order.desc}</p>
                <p><strong>Quantity:</strong> ${order.quantity}</p>
                <p><strong>Price:</strong> ${order.price}</p>
            </div>
  
            <div class="detail-group">
                <h4>Customer Information</h4>
                <p><strong>Name:</strong> ${order.cname}</p>
                <p><strong>Email:</strong> ${order.email}</p>
            </div>
        </div>
      `;
        }

        // Show the modal
        orderModal.style.display = "flex";
        document.body.style.overflow = "hidden";
      }

      function viewRejectedOrderDetails(orderId) {
        const supplierData = sessionStorage.getItem("supplier");
        if (!supplierData) {
          alert("Supplier data not found. Please login again.");
          return;
        }

        const supplier = JSON.parse(supplierData);
        const rejectedOrdersContainer =
          document.getElementById("rejectedOrders");
        const rows = rejectedOrdersContainer.querySelectorAll("tbody tr");

        for (const row of rows) {
          const rowOrderId = row.cells[0].textContent;
          if (rowOrderId === orderId) {
            const responseSupplierId = row.cells[8].textContent;
            const acceptedSupplierId =
              row.cells.length > 10 ? row.cells[10].textContent : null;

            const isCurrentSupplier =
              responseSupplierId === supplier.supplierId.toString();

            const isAssignedToSomeoneElse =
              acceptedSupplierId &&
              acceptedSupplierId.toString() !== supplier.supplierId.toString();

            const isAssignedToCurrentSupplier =
              acceptedSupplierId &&
              acceptedSupplierId.toString() === supplier.supplierId.toString();

            const order = {
              order_id: rowOrderId,
              cname: row.cells[1].textContent.split(" (")[0],
              email: row.cells[1].textContent.match(/\((.*?)\)/)[1],
              Part_Name: row.cells[2].textContent,
              category: row.cells[3].textContent,
              working_status: row.cells[4].querySelector(".badge").textContent,
              desc: row.cells[5].textContent,
              tv: row.cells[6].textContent,
              pr: row.cells[7].textContent,
              isApproved: "Approved",
              isCurrentSupplier,
              isAssignedToSomeoneElse,
              isAssignedToCurrentSupplier,
              acceptedSupplierId,
            };

            showOrderModal(order, "rejected");
            return;
          }
        }

        showNotFoundMessage("rejected");
      }

      function showOrderModal(order, type) {
        let assignmentStatusHtml = "";

        if (type === "accepted") {
          assignmentStatusHtml = order.isAssignedToCurrentSupplier
            ? `<div class="detail-group">
            <h4>Assignment Status</h4>
            <p class="text-success"><i class="fas fa-check-circle"></i> This order is assigned to you</p>
        </div>`
            : `<div class="detail-group">
            <h4>Assignment Status</h4>
            <p class="text-warning"><i class="fas fa-exclamation-triangle"></i> 
                ${
                  order.acceptedSupplierId
                    ? "This order is assigned to another supplier"
                    : "This order is not assigned to any supplier"
                }
            </p>
        </div>`;
        } else if (type === "rejected") {
          if (order.isAssignedToSomeoneElse) {
            assignmentStatusHtml = `
            <div class="detail-group">
                <h4>Assignment Status</h4>
                <p class="text-warning"><i class="fas fa-exclamation-triangle"></i> 
                    This order was assigned to another supplier
                </p>
            </div>`;
          } else if (order.isAssignedToCurrentSupplier) {
            assignmentStatusHtml = `
            <div class="detail-group">
                <h4>Assignment Status</h4>
                <p class="text-success"><i class="fas fa-check-circle"></i> 
                    This order was assigned to you
                </p>
            </div>`;
          } else if (order.isCurrentSupplier) {
            assignmentStatusHtml = `
            <div class="detail-group">
                <h4>Assignment Status</h4>
                <p class="text-info"><i class="fas fa-info-circle"></i> 
                    You rejected this order
                </p>
            </div>`;
          }
        }

        document.getElementById("orderModalBody").innerHTML = `
      <div class="order-details">
          <div class="detail-group">
              <h4>Order Information</h4>
              <p><strong>Order ID:</strong> ${order.order_id}</p>
              <p><strong>Status:</strong> <span class="badge ${
                order.working_status === "Completed"
                  ? "badge-success"
                  : order.working_status === "Working"
                  ? "badge-primary"
                  : "badge-warning"
              }">${order.working_status}</span></p>
              <p><strong>Approval Status:</strong> <span class="badge badge-success">${
                order.isApproved
              }</span></p>
          </div>
          
          ${assignmentStatusHtml}
          
          <div class="detail-group">
              <h4>Part Details</h4>
              <p><strong>Part Name:</strong> ${order.Part_Name}</p>
              <p><strong>Category:</strong> ${order.category}</p>
              <p><strong>Description:</strong> ${order.desc}</p>
              <p><strong>Quantity:</strong> ${order.tv}</p>
              <p><strong>Price:</strong> ${order.pr}</p>
          </div>
          
          <div class="detail-group">
              <h4>Customer Information</h4>
              <p><strong>Name:</strong> ${order.cname}</p>
              <p><strong>Email:</strong> ${order.email}</p>
          </div>
          
          ${
            type === "rejected"
              ? `
          <div class="detail-group">
              <h4>Rejection Details</h4>
              <p class="text-danger"><i class="fas fa-exclamation-circle"></i> 
                  ${
                    order.isCurrentSupplier
                      ? "You rejected"
                      : "This order was rejected"
                  }
              </p>
          </div>`
              : ""
          }
      </div>
    `;

        orderModal.style.display = "flex";
        document.body.style.overflow = "hidden";
      }

      function showNotFoundMessage(type) {
        document.getElementById("orderModalBody").innerHTML = `
      <div class="no-data">Order details not found in ${type} orders.</div>
    `;
        orderModal.style.display = "flex";
        document.body.style.overflow = "hidden";
      }

      function viewRejectedOrderDetails(orderId) {
        const supplierData = sessionStorage.getItem("supplier");
        if (!supplierData) {
          alert("Supplier data not found. Please login again.");
          return;
        }

        const supplier = JSON.parse(supplierData);

        // Find the order in rejected orders
        const rejectedOrdersContainer =
          document.getElementById("rejectedOrders");
        const rows = rejectedOrdersContainer.querySelectorAll("tbody tr");

        let order = null;
        let assignedToSomeoneElse = false;

        for (const row of rows) {
          const rowOrderId = row.cells[0].textContent;
          if (rowOrderId === orderId) {
            const responseSupplierId = row.cells[8].textContent; // Assuming this is supplier_Id
            const isCurrentSupplier =
              responseSupplierId === supplier.supplierId.toString();

            const acceptedSupplierId =
              row.cells.length > 10 ? row.cells[10].textContent : null;

            order = {
              order_id: rowOrderId,
              cname: row.cells[1].textContent.split(" (")[0],
              email: row.cells[1].textContent.match(/\((.*?)\)/)[1],
              Part_Name: row.cells[2].textContent,
              category: row.cells[3].textContent,
              working_status: row.cells[4].querySelector(".badge").textContent,
              desc: row.cells[5].textContent,
              tv: row.cells[6].textContent,
              pr: row.cells[7].textContent,
              isApproved: "Approved",
              supplierResponses: [
                {
                  supplier_Id: responseSupplierId,
                  status: row.cells[9].querySelector(".badge").textContent,
                  respondedAt: new Date().toISOString(),
                },
              ],
              isCurrentSupplier: isCurrentSupplier,
              acceptedSupplierId: acceptedSupplierId,
            };

            // New logic: Check if this order is assigned to someone else
            if (
              acceptedSupplierId &&
              acceptedSupplierId !== supplier.supplierId.toString()
            ) {
              assignedToSomeoneElse = true;
            }

            break;
          }
        }

        if (!order) {
          document.getElementById("orderModalBody").innerHTML = `
        <div class="no-data">Order details not found in rejected orders.</div>
      `;
        } else {
          // Populate the modal with order details
          let assignmentStatusHtml = "";

          if (assignedToSomeoneElse) {
            assignmentStatusHtml = `
          <div class="detail-group">
            <h4>Assignment Status</h4>
            <p class="text-warning"><i class="fas fa-exclamation-triangle"></i> This order was assigned to another supplier</p>
            
          </div>
        `;
          } else if (order.isCurrentSupplier) {
            assignmentStatusHtml = `
          <div class="detail-group">
            <h4>Assignment Status</h4>
            <p class="text-info"><i class="fas fa-info-circle"></i> You rejected this order</p>
          </div>
        `;
          }

          document.getElementById("orderModalBody").innerHTML = `
        <div class="order-details">
          <div class="detail-group">
            <h4>Order Information</h4>
            <p><strong>Order ID:</strong> ${order.order_id}</p>
            <p><strong>Status:</strong> <span class="badge ${
              order.working_status === "Completed"
                ? "badge-success"
                : order.working_status === "Working"
                ? "badge-primary"
                : "badge-warning"
            }">${order.working_status}</span></p>
            <p><strong>Approval Status:</strong> <span class="badge badge-success">${
              order.isApproved
            }</span></p>
          </div>
  
          ${assignmentStatusHtml}
  
          <div class="detail-group">
            <h4>Part Details</h4>
            <p><strong>Part Name:</strong> ${order.Part_Name}</p>
            <p><strong>Category:</strong> ${order.category}</p>
            <p><strong>Description:</strong> ${order.desc}</p>
            <p><strong>Quantity:</strong> ${order.tv}</p>
            <p><strong>Price:</strong> ${order.pr}</p>
          </div>
  
          <div class="detail-group">
            <h4>Customer Information</h4>
            <p><strong>Name:</strong> ${order.cname}</p>
            <p><strong>Email:</strong> ${order.email}</p>
          </div>
  
          <div class="detail-group">
            <h4>Supplier Response</h4>
            <p><strong>Supplier ID:</strong> ${
              order.supplierResponses[0].supplier_Id
            }</p>
            <p><strong>Response:</strong> <span class="badge badge-danger">${
              order.supplierResponses[0].status
            }</span></p>
            ${
              order.isCurrentSupplier
                ? '<p class="text-danger"><i class="fas fa-exclamation-circle"></i> You rejected this order</p>'
                : '<p class="text-danger"><i class="fas fa-exclamation-circle"></i> This order was rejected</p>'
            }
          </div>
        </div>
      `;
        }

        // Show the modal
        orderModal.style.display = "flex";
        document.body.style.overflow = "hidden";
      }

      async function updateOrderStatus(orderId, supplierId, status) {
        if (isNaN(supplierId)) {
          console.error("Invalid supplier ID format");
          return;
        }

        const confirmMessage =
          status === "Accepted"
            ? "Are you sure you want to accept this order?"
            : "Are you sure you want to reject this order?";

        if (!confirm(confirmMessage)) {
          return;
        }

        try {
          const response = await fetch(
            "https://backend-api-3qcm.onrender.com/api/suppliers/orders/respond",
            {
              method: "PUT",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify({
                order_id: orderId,
                supplierId: Number(supplierId),
                status: status,
              }),
            }
          );

          if (!response.ok) throw new Error("Server error");

          alert("Order updated successfully!");
          location.reload();
        } catch (error) {
          console.error("Error updating order:", error);
          alert("Failed to update order.");
        }
      }

      function displayOrderStats(orders, supplier) {
        const statsContainer = document.getElementById("orderStats");

        // Filter orders based on different statuses
        const approvedOrders = orders.filter(
          (order) => order.isApproved === "Approved"
        );

        // Pending orders (approved but not responded to by this supplier)
        const pendingOrders = approvedOrders.filter(
          (order) =>
            !order.supplierResponses ||
            !order.supplierResponses.some(
              (response) => response.supplier_Id === supplier.supplierId
            )
        );

        // Accepted orders by this supplier
        const acceptedOrders = approvedOrders.filter(
          (order) =>
            order.supplierResponses &&
            order.supplierResponses.some(
              (response) =>
                response.supplier_Id === supplier.supplierId &&
                response.status === "Accepted"
            )
        );

        // Rejected orders by this supplier
        const rejectedOrders = approvedOrders.filter(
          (order) =>
            order.supplierResponses &&
            order.supplierResponses.some(
              (response) =>
                response.supplier_Id === supplier.supplierId &&
                response.status === "Rejected"
            )
        );

        // Orders assigned to this supplier
        const assignedOrders = approvedOrders.filter(
          (order) =>
            order.isSupplierAccepted &&
            order.acceptedSupplier?.supplier_Id === supplier.supplierId
        );

        // Create the stats HTML
        statsContainer.innerHTML = `
    <div class="info-item">
      <h3>Total Approved Orders</h3>
      <p>${approvedOrders.length}</p>
    </div>
    <div class="info-item">
      <h3>Pending Your Response</h3>
      <p>${pendingOrders.length}</p>
    </div>
    <div class="info-item">
      <h3>Your Accepted Orders</h3>
      <p>${acceptedOrders.length}</p>
    </div>
    <div class="info-item">
      <h3>Your Rejected Orders</h3>
      <p>${rejectedOrders.length}</p>
    </div>
    <div class="info-item">
      <h3>Assigned to You</h3>
      <p>${assignedOrders.length}</p>
    </div>
    <div class="info-item">
      <h3>Completion Rate</h3>
      <p>${
        assignedOrders.length > 0
          ? Math.round(
              (assignedOrders.filter((o) => o.working_status === "Completed")
                .length /
                assignedOrders.length) *
                100
            ) + "%"
          : "N/A"
      }</p>
    </div>
  `;
      }

      document.getElementById("logout").addEventListener("click", () => {
        sessionStorage.clear();
        window.location.href = "login.html";
      });
    </script>
  </body>
</html>
